---
layout: post
title: First patch ‚≠ê - Adjust prefix of dcn31_apg construct function name
date: 2025-04-03T17:51:29Z
author: LeoSilvaGomes
categories: kernel
---
**Obs inicial:** Esse relato faz parte da disciplina de Software Livre ministrada pelo Professor Paulo Meirelles dada no IME - USP. Alguns coment√°rios s√£o referentes a prazos que a pr√≥pria disciplina delimita.

Finalmente chegamos na nossa contribui√ß√£o para o kernel, depois de fazer v√°rias configura√ß√µes e decidir utilizar o _iio_ (em primeiro momento).

`Por volta da primeira semana de abril`
Eu e minha dupla come√ßamos a passar pelo _pad_ de contribui√ß√£o e vimos algumas contribui√ß√µes bem tranquilas. Nosso primeiro contato foi com o ajuste de algumas fun√ß√µes em alguma parte do modulo. Rodamos `git grep <o nome da fun√ß√£o>` que queriamos modificar e acabamos encontrando algumas coisas que poderiam ser modificadas, entramos em contato com o monitor e ele nos orientou a continuar explorando e esperar pela proxima aula para acompanharmos a quest√£o do envio do patch.

Esperado a aula, minha dupla pode comparecer a disciplina e eu estava em um evento, nesse sentido ap√≥s a aula me reuni com minha dupla para receber orienta√ß√µes de pr√≥ximo passo e foi decidido que iriamos fazer altera√ß√µes agora em outra parte do kernel... agora sendo o _drm_ o nosso foco. 

Nesse momento entramos de f√©rias (voltei para minha cidade natal e deixei minha maquina com linux ligada para acessar remotamente), tentei iniciar a contribui√ß√£o, mas de primeiro eu n√£o consegui acessar o pad, ent√£o entrei em contato com o monitor que me ajudou enviando o pdf do pad. A partir desse ponto eu consegui iniciar algumas coisas a respeito de clonar a nova ramifica√ß√£o, fazer a procura dos arquivos necess√°rios para a modifica√ß√£o do problema que meu amigo tinha escolhido que no caso era `Code Refactor: Add prefix to DC functions to improve the debug with ftrace`.

---------

### Vamos come√ßar a contribui√ß√£o

Depois de preparar o ambiente para agora sim contribuir na ramifica√ß√£o certa, no caso o _drm_, eu consegui fazer um `git grep dcn` que foi uma das indica√ß√µes dos monitores para altera√ß√£o.

Apareceu bastante resultado e acabei indo no olho para ver qual funcionava melhor, fui passando por v√°rios arquivos e encontrei dois que poderiam funcionar:

``` bash
> drivers/gpu/drm/amd/display/dc/dcn31/dcn31_apg.c
> drivers/gpu/drm/amd/display/dc/dccg/dcn20/dcn20_dccg.c
```

Confirmei com o eu amigo sobre a minha hipotese e disse para a gente ir tentando cada um em um para a gente infrentar a barreiras e ir falando para o outro a cada passo...

**Obs blackout:** Como eu estava remoto eu estava com medo de meu computador desligar, ent√£o o dia chegou, no meio da minha visita a minha fam√≠lia eu fiquei off ao meu progresso, mas j√° tinha dado passos bem interessantes.

Quando voltei a S√£o Paulo, retomei o desenvolvimento e percebi um erro que n√£o tinha notado, o _drm_ n√£o estava _buildando_, falei com o monitor e ele me disse que isso era problema com a arquitetura da vm, que no caso estava como `arm64`, fiz a modifica√ß√£o das configs para rodar em `x86_64` rodando:

``` bash
> kw init --template
> make ARCH=x86_64 allnoconfig 
```

Ap√≥s isso, consegui buildar o _drm_ tranquilamente e comecei as modifica√ß√µes do arquivo `dcn31_apg`, mudei ent√£o a fun√ß√£o `construct` que era a fun√ß√£o que estava com o nome faltando informa√ß√£o para o _ftrace_, a fun√ß√£o estava com a declara√ß√£o como `apg31_construct` e foi modificada para `dcn31_apg_construct`. modifiquei no `.c` e no `.h` como vi em um exemplo que o monitor compartilhou.

Ent√£o ap√≥s as modifica√ß√µes eu habilitei todas as dependencias e modulos para que eu conseguisse testar minhas altera√ß√µes, modifiquei pelo _kw_ com o comando `kw build --menu`. Nesse momento eu fiz a busca pelo `F8` e procurei pelo `DRM_AMD_DC`, _config_ que minha altera√ß√£o fazia parte, descobri que essa _config_ apenas caminha pelo _path_ de onde minha altera√ß√£o estava at√© encontrar um arquivo `Kconfig`, ou seja:

``` bash
$ cd drivers/gpu/drm/amd/display/dc/dcn31
drivers/gpu/drm/amd/display/dc/dcn31/ $ cd ..
drivers/gpu/drm/amd/display/dc/ $ ls                # n√£o encontrei Kconfig, repete cd .. at√© encontrar
```

Ap√≥s habilitado, rodei o build e pela minha surpresa e felicidade deu erro ‚≠ê , significa que o modulo foi habilitado e que agora eu tinha algumas coisas para ajustar, ent√£o segue o passo a passo do que aconteceu:

| Erro nos arquivos que dependem da fun√ß√£o alterada | `git grep` para buscar arquivos que preciso modificar | Resultado das altera√ß√µes |
| :- |  :- | :- |
| ![Image](https://github.com/user-attachments/assets/e7aa291a-9981-434d-bf66-5d53b6cedd05) | ![Image](https://github.com/user-attachments/assets/1b76e7ba-7598-421a-8f2d-cb946144d194) | ![Image](https://github.com/user-attachments/assets/d8394a7d-b19d-4412-b572-93143d84c93f) |

Ent√£o ap√≥s fazer as corre√ß√µes eu fiz o:

``` bash
> git add .
> git commit                       # escrevi a mensagem detalhada
```

Ap√≥s refazer a mensagem de commit v√°rias vezes at√© ficar satisfeito eu rodei o comando para enviar o email:

``` bash
> kw send-patch --send -1 --simulate --private --to=freesoftware2025@gmail.com
```

üéâ  AEEE tudo certo ~Infelizmente n√£o~

Eu tinha deixado o `--simulate`no comando e n√£o tinha percebido que na verdade eu n√£o tinha enviado e apenas simulado o envio, ent√£o eu finalmente removi esse _flag_ fiz as configura√ß√µes do _smtp_ que precisava e do meu email google (com a ajuda do monitor) e finalmente consegui enviar com o comando:

``` bash
> kw send-patch --send -1 --private --to=freesoftware2025@gmail.com --cc=leonardodasigomes@gmail.com
```

-------

### Coment√°rios

Foi muito tranquilo a contribui√ß√£o em si, o que deu mais problema foi a quest√£o de modifica√ß√£o e mudan√ßas de rotas ocorridas nesse processo que ocasionou em mais configura√ß√µes de ambiente. Al√©m disso houve um atraso por parte da indisponibilidade da minha maquina remota por algum tempo, mas nada que n√£o fosse resolvido um tempinho depois.


